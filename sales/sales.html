<!DOCTYPE html>
<html lang="en">
  <head>
		<title> sales </title>
		<meta charset="utf-8">
		<link href="../assets/sales.css" rel="stylesheet"/>
	</head>
	<body>
		<main>
		  <?php
		    require '../includes/helpers.inc.php';
        
        //establish db connection
        $con = connecttodb("localhost", "pos_shop", "root", "");		    
		      
		    if(isset($_GET['history']) && $_GET['history'] == 'on'){
          $status1 = "";
          $status2 = "active";
          $status3 = "";
          $status4 = "";
          include '../includes/nav.inc.php';	            
		     }else if(isset($_GET['settings']) && $_GET['settings'] == 'on'){
		      $status1 = "";
          $status2 = "";
          $status3 = "active";
          $status4 = "";
          include '../includes/nav.inc.php';
		     }else if(isset($_GET['settings']) && $_GET['settings'] == 'on'){
		      $status1 = "";
          $status2 = "";
          $status3 = "";
          $status4 = "active";
          include '../includes/nav.inc.php';
         }else{
          $status1 = "active";
          $status2 = "";
          $status3 = "";
          $status4 = "";
          
          //left panel
          include '../includes/nav.inc.php';
          
          //cancel the current transaction
          if(isset($_POST["action"]) && $_POST["action"] == "cancel"){
            cancel_transaction($con);
          }          
          
          //central panel
          $charge = 0.0;
          $paid = 0.0;
          $items_in_cart = get_items_in_cart($con);
          $change = $paid > $charge ? $paid - $charge : 0.0;
          include '../includes/sales_cart_panel.inc.php';
          
          //right panel
          include '../includes/sales_left_panel.inc.php';
         }
         
         function cancel_transaction($con){
            try{
             $sql = 'DELETE FROM cart';
             $con->exec($sql);
            }catch(PDOException $e){
               report_error($e);            
            }         
          }
         
         function get_items_in_cart($con){
          try{
            global $charge;
            $sql = "SELECT * FROM cart";
            $pdo = $con->query($sql);
            $results = [];
            while($results = $pdo->fetch())
            $items[] = array("item_id" => "", "item_name" => "",
               "item_price" => "", "item_quantity" => "", "item_amount" => "");
               
            if(!$results){
              $items = [];
             }
              
            foreach($items as $row){
              $items[] = array ('item_id' => $row["item_id"], 
                       'item_name' => $row["item_name"],
                       'item_price' => $row["item_price"],
                       'item_quantity' => $row["item_quantity"],
                       'item_amount' => $row["item_amount"]);
              $charge += $row["item_amount"];             
            }
            
            return $items;
          }catch(PDOException $e){
            report_error($e);
          }
          
          function update_table_value($con, $id, $value){
            try{
             $sql = 'UPDATE cart SET item_quantity= :quantity WHERE 
                      id= :id';
              $statement = $con->prepare($sql);
              $statement->bindValue(':quantity', $value);
              $statement->bindValue(':id', $id);
              $statement->execute();
            }catch(PDOException $e){
               report_error($e);            
            }
          }         
         }
      ?>						
				</section>	
			</main>
	</body>
<html>